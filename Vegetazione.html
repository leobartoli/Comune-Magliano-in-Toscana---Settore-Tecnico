<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roboflow Mobile Detection</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
            background: #f0f0f0;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        #preview, #videoElement {
            max-width: 100%;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: none;
        }
        #videoContainer {
            position: relative;
            display: none;
        }
        #videoElement {
            display: block;
            width: 100%;
        }
        #videoCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        button {
            padding: 15px 30px;
            font-size: 16px;
            margin: 10px;
            border-radius: 8px;
            border: none;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            transition: background 0.3s;
        }
        button:active {
            background: #45a049;
        }
        button.stop {
            background: #f44336;
        }
        button.stop:active {
            background: #da190b;
        }
        #results {
            text-align: left;
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .detection {
            border-left: 3px solid #4CAF50;
            padding-left: 10px;
            margin: 10px 0;
            background: white;
            padding: 10px;
            border-radius: 4px;
        }
        .config {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .config input {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
        }
        .config small {
            color: #666;
            display: block;
            margin-top: 8px;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #c62828;
        }
        .loading {
            color: #1976d2;
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .info {
            background: #fff3e0;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 13px;
            color: #e65100;
        }
        .stats {
            background: #e8f5e9;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ Roboflow Detection</h1>
        
        <div class="config">
            <h3>‚öôÔ∏è Configurazione</h3>
            <label><strong>API Key:</strong></label>
            <input type="text" id="apiKey" placeholder="hjcudt3Kqs6pA1yEYh51" value="hjcudt3Kqs6pA1yEYh51">
            
            <label><strong>Model Endpoint:</strong></label>
            <input type="text" id="modelEndpoint" placeholder="workspace/modello/1" value="vegetazione-mura-storiche-cwo8b/1">
            
            <small>üìç Trova in: Roboflow ‚Üí Deploy ‚Üí Hosted API ‚Üí MODEL_ID</small>
        </div>
        
        <input type="file" id="fileInput" accept="image/*" capture="environment" style="display:none">
        <input type="file" id="fileInput2" accept="image/*" style="display:none">
        
        <div id="buttonContainer">
            <button onclick="document.getElementById('fileInput').click()">
                üì∑ Scatta Foto
            </button>
            
            <button onclick="document.getElementById('fileInput2').click()">
                üñºÔ∏è Carica Immagine
            </button>
            
            <button onclick="startCamera()" id="startCameraBtn">
                üé• Avvia Telecamera
            </button>
        </div>
        
        <button onclick="stopCamera()" id="stopCameraBtn" class="stop" style="display:none;">
            ‚èπÔ∏è Ferma Telecamera
        </button>
        
        <canvas id="preview"></canvas>
        
        <div id="videoContainer">
            <video id="videoElement" autoplay playsinline></video>
            <canvas id="videoCanvas"></canvas>
        </div>
        
        <div id="results"></div>
    </div>
    
    <script>
        let stream = null;
        let detectionInterval = null;
        let isDetecting = false;
        
        // Gestisci upload file
        document.getElementById('fileInput').addEventListener('change', handleImage);
        document.getElementById('fileInput2').addEventListener('change', handleImage);
        
        async function handleImage(event) {
            stopCamera();
            
            const file = event.target.files[0];
            if (!file) return;
            
            const apiKey = document.getElementById('apiKey').value.trim();
            const modelEndpoint = document.getElementById('modelEndpoint').value.trim();
            
            if (!apiKey || !modelEndpoint) {
                showError('‚ö†Ô∏è Inserisci API Key e Model Endpoint!');
                return;
            }
            
            const canvas = document.getElementById('preview');
            canvas.style.display = 'block';
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = async function() {
                const maxWidth = 640;
                const scale = maxWidth / img.width;
                canvas.width = img.width * scale;
                canvas.height = img.height * scale;
                
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                const base64 = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
                await detectObjects(base64, canvas, apiKey, modelEndpoint);
            };
            
            img.src = URL.createObjectURL(file);
        }
        
        async function startCamera() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const modelEndpoint = document.getElementById('modelEndpoint').value.trim();
            
            if (!apiKey || !modelEndpoint) {
                showError('‚ö†Ô∏è Inserisci API Key e Model Endpoint!');
                return;
            }
            
            try {
                // Nascondi preview immagine
                document.getElementById('preview').style.display = 'none';
                
                // Richiedi accesso alla telecamera
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment', // Usa telecamera posteriore
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                
                const video = document.getElementById('videoElement');
                const videoContainer = document.getElementById('videoContainer');
                const canvas = document.getElementById('videoCanvas');
                
                video.srcObject = stream;
                videoContainer.style.display = 'block';
                
                // Nascondi pulsanti normali, mostra stop
                document.getElementById('buttonContainer').style.display = 'none';
                document.getElementById('stopCameraBtn').style.display = 'inline-block';
                
                // Attendi che il video sia pronto
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    
                    // Avvia detection continuo
                    startContinuousDetection(video, canvas, apiKey, modelEndpoint);
                };
                
            } catch (error) {
                console.error('Errore telecamera:', error);
                showError('‚ùå Impossibile accedere alla telecamera: ' + error.message);
            }
        }
        
        function stopCamera() {
            // Ferma lo stream video
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            // Ferma detection
            if (detectionInterval) {
                clearInterval(detectionInterval);
                detectionInterval = null;
            }
            
            isDetecting = false;
            
            // Nascondi video
            document.getElementById('videoContainer').style.display = 'none';
            
            // Mostra pulsanti normali
            document.getElementById('buttonContainer').style.display = 'block';
            document.getElementById('stopCameraBtn').style.display = 'none';
            
            // Pulisci risultati
            document.getElementById('results').innerHTML = '';
        }
        
        function startContinuousDetection(video, canvas, apiKey, modelEndpoint) {
            let frameCount = 0;
            
            detectionInterval = setInterval(async () => {
                if (isDetecting) return; // Salta se sta gi√† rilevando
                
                isDetecting = true;
                frameCount++;
                
                try {
                    // Cattura frame dal video
                    const tempCanvas = document.createElement('canvas');
                    const maxWidth = 640;
                    const scale = maxWidth / video.videoWidth;
                    
                    tempCanvas.width = video.videoWidth * scale;
                    tempCanvas.height = video.videoHeight * scale;
                    
                    const ctx = tempCanvas.getContext('2d');
                    ctx.drawImage(video, 0, 0, tempCanvas.width, tempCanvas.height);
                    
                    const base64 = tempCanvas.toDataURL('image/jpeg', 0.6).split(',')[1];
                    
                    // Rileva oggetti
                    await detectObjectsLive(base64, canvas, apiKey, modelEndpoint, frameCount);
                    
                } catch (error) {
                    console.error('Errore detection:', error);
                } finally {
                    isDetecting = false;
                }
                
            }, 1000); // Rileva ogni secondo
        }
        
        async function detectObjectsLive(base64Image, canvas, apiKey, modelEndpoint, frameCount) {
            try {
                const url = `https://detect.roboflow.com/${modelEndpoint}?api_key=${apiKey}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: base64Image
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result && result.predictions) {
                    drawPredictionsOnVideo(result.predictions, canvas);
                    displayResultsLive(result.predictions, frameCount);
                }
                
            } catch (error) {
                console.error('Errore rilevamento:', error);
            }
        }
        
        function drawPredictionsOnVideo(predictions, canvas) {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (predictions.length === 0) return;
            
            ctx.strokeStyle = '#00FF00';
            ctx.lineWidth = 4;
            ctx.font = 'bold 20px Arial';
            ctx.fillStyle = '#00FF00';
            ctx.shadowColor = 'black';
            ctx.shadowBlur = 8;
            
            predictions.forEach(pred => {
                const x = pred.x - pred.width / 2;
                const y = pred.y - pred.height / 2;
                
                // Box
                ctx.strokeRect(x, y, pred.width, pred.height);
                
                // Label con sfondo
                const label = `${pred.class} ${(pred.confidence * 100).toFixed(0)}%`;
                const textWidth = ctx.measureText(label).width;
                
                ctx.fillStyle = 'rgba(0, 255, 0, 0.8)';
                ctx.fillRect(x, y - 30, textWidth + 10, 28);
                
                ctx.fillStyle = 'black';
                ctx.fillText(label, x + 5, y - 8);
            });
            
            ctx.shadowBlur = 0;
        }
        
        function displayResultsLive(predictions, frameCount) {
            const resultsDiv = document.getElementById('results');
            
            if (predictions.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="stats">
                        Frame: ${frameCount} | üîç Nessun oggetto rilevato
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="stats">
                    Frame: ${frameCount} | ‚úÖ Rilevati <strong>${predictions.length}</strong> oggetti
                </div>
            `;
            
            predictions.forEach((pred, i) => {
                html += `
                    <div class="detection">
                        <strong>${i + 1}. ${pred.class}</strong> - ${(pred.confidence * 100).toFixed(1)}%
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }
        
        async function detectObjects(base64Image, canvas, apiKey, modelEndpoint) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p class="loading">üîÑ Analisi in corso...</p>';
            
            try {
                const url = `https://detect.roboflow.com/${modelEndpoint}?api_key=${apiKey}`;
                
                console.log('üîó URL richiesta:', url);
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: base64Image
                });
                
                console.log('üì° Status risposta:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 200)}`);
                }
                
                const result = await response.json();
                console.log('‚úÖ Risposta:', result);
                
                if (!result || !result.predictions) {
                    showError('‚ö†Ô∏è Risposta non valida', result);
                    return;
                }
                
                displayResults(result, canvas);
                
            } catch (error) {
                console.error('‚ùå Errore:', error);
                showError(`‚ùå Errore: ${error.message}`);
            }
        }
        
        function displayResults(result, canvas) {
            const resultsDiv = document.getElementById('results');
            const predictions = result.predictions || [];
            
            if (predictions.length === 0) {
                resultsDiv.innerHTML = '<p>üîç Nessun oggetto rilevato</p>';
                return;
            }
            
            const ctx = canvas.getContext('2d');
            ctx.strokeStyle = '#00FF00';
            ctx.lineWidth = 3;
            ctx.font = 'bold 16px Arial';
            ctx.fillStyle = '#00FF00';
            ctx.shadowColor = 'black';
            ctx.shadowBlur = 4;
            
            predictions.forEach(pred => {
                const x = pred.x - pred.width / 2;
                const y = pred.y - pred.height / 2;
                
                ctx.strokeRect(x, y, pred.width, pred.height);
                ctx.fillText(
                    `${pred.class} ${(pred.confidence * 100).toFixed(1)}%`,
                    x + 5,
                    y - 8
                );
            });
            
            ctx.shadowBlur = 0;
            
            let html = `<h3>‚úÖ Rilevati ${predictions.length} oggetti:</h3>`;
            predictions.forEach((pred, i) => {
                html += `
                    <div class="detection">
                        <strong>${i + 1}. ${pred.class}</strong><br>
                        Confidenza: <strong>${(pred.confidence * 100).toFixed(1)}%</strong><br>
                        Posizione: x=${pred.x.toFixed(0)}, y=${pred.y.toFixed(0)}
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }
        
        function showError(message, debugData = null) {
            const resultsDiv = document.getElementById('results');
            let html = `<div class="error">${message}</div>`;
            
            if (debugData) {
                html += `<details style="margin-top: 10px; background: #f5f5f5; padding: 10px; border-radius: 4px;">
                    <summary style="cursor: pointer; font-weight: bold;">üîç Dettagli</summary>
                    <pre style="overflow-x: auto; font-size: 11px;">${JSON.stringify(debugData, null, 2)}</pre>
                </details>`;
            }
            
            resultsDiv.innerHTML = html;
        }
    </script>
</body>
</html>